<script>
    // --- CONSTANTS AND OS DETECTION ---

    // Hypothetical URL for a Mac package (User requested Mac support)
    const macScriptUrl = "Not supported for mac lol";
    // Hypothetical URL for the Mac completion script
    const macCompletionUrl = "Not supported for mac lolp";
    // Default URL for the Linux Debian package
    const debPackageUrl = "https://github.com/Fionn-Playz/Hecker-Typer/releases/latest/download/hack.sh";

    let userOS = 'Linux'; // Default
    let hasDownloaded = false;
    let downloadLink = debPackageUrl; // Track the link to download if user confirms in modal

    // --- UTILITY FUNCTIONS ---

    // Function to trigger a download using a temporary hidden link
    // Added optional filename parameter for explicit saving
    function triggerDownload(url, filename = '', delay = 0) {
        if (url && url !== '#') {
            setTimeout(() => {
                const tempLink = document.createElement('a');
                tempLink.href = url;

                // Set download attribute explicitly
                if (filename) {
                    tempLink.setAttribute('download', filename);
                } else {
                    // Use generic attribute if no filename is provided
                    tempLink.setAttribute('download', '');
                }

                tempLink.style.display = 'none';
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
            }, delay);
        }
    }

    // --- OS SWITCHER FUNCTION ---

    function setOS(osName) {
        userOS = osName;
        // Reset the download state when switching OS to ensure the user downloads the correct file.
        hasDownloaded = false;
        initUI(); // Re-initialize UI based on new OS selection
    }

    // --- MODAL FUNCTIONS ---

    function showOSWarningModal(downloadUrl) {
        downloadLink = downloadUrl;
        // Since we use triggerDownload now, the modal button just executes the downloadClicked logic after confirming
        document.getElementById('modalContinueButton').href = 'javascript:void(0)';
        document.getElementById('incompatibleOSName').textContent = userOS;
        document.getElementById('osWarningModal').classList.remove('hidden');
    }

    function hideOSWarningModal() {
        document.getElementById('osWarningModal').classList.add('hidden');
    }

    function continueDownloadFromModal() {
        // Replicates the action taken by downloadClicked after a successful check
        if (!hasDownloaded) {
            // Since this is Windows, we only download the .deb file
            triggerDownload(debPackageUrl);

            updateSectionColors(
                'downloadSection',
                'bg-gray-100',
                'border-gray-400',
                'text-gray-700',
                '1. Package Downloaded'
            );

            const button = document.getElementById('downloadButton');
            button.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-indigo-600', 'hover:bg-indigo-700');
            button.classList.add('bg-gray-400', 'hover:bg-gray-500');

            hasDownloaded = true;

            updateSectionColors(
                'installSection',
                'bg-indigo-50',
                'border-indigo-500',
                'text-indigo-800',
                '2. Install the Utility'
            );

            hideOSWarningModal();
        }
    }


    // --- UI/STATE FUNCTIONS ---

    function updateSectionColors(sectionId, newBg, newBorder, newTitleColor, newTitleText) {
        const section = document.getElementById(sectionId);
        const title = document.getElementById(sectionId.replace('Section', 'Title'));

        // Classes to remove (all possible old states)
        const oldBg = ['bg-indigo-50', 'bg-gray-100'];
        const oldBorder = ['border-indigo-500', 'border-gray-400'];
        const oldTitleColor = ['text-indigo-800', 'text-gray-700'];

        if (section) {
            section.classList.remove(...oldBg, ...oldBorder);
            section.classList.add(newBg, newBorder);
        }
        if (title) {
            title.classList.remove(...oldTitleColor);
            title.classList.add(newTitleColor);
            title.textContent = newTitleText;
        }
    }

    function downloadClicked(event) {
        // Stop the link from opening immediately as we manage the download via JS now
        event.preventDefault();

        if (!hasDownloaded) {
            // Check only for incompatible OS (Windows)
            if (userOS === 'Windows') {
                showOSWarningModal(debPackageUrl); // Show the warning modal
                return;
            }

            // --- STEP 0: Trigger Download(s) ---
            if (userOS === 'Mac') {
                // FIX: Explicitly setting the filenames here ensures the browser saves both correctly.
                // 1. Download backup.sh first (immediately)
                triggerDownload(macScriptUrl, 'backup.sh');
                // 2. Download backup_completion.sh after 500ms
                triggerDownload(macCompletionUrl, 'backup_completion.sh', 500);
            } else {
                // Trigger single download for Linux/ChromeOS
                triggerDownload(debPackageUrl);
            }

            // --- STEP 1: Update Download Card (From ACTIVE/Indigo to COMPLETED/Gray) ---
            updateSectionColors(
                'downloadSection',
                'bg-gray-100',
                'border-gray-400',
                'text-gray-700',
                userOS === 'Mac' ? '1. Files Downloading...' : '1. Package Downloading...'
            );

            // 1. Change Download Button to Grey (To visually indicate completion)
            const button = event.currentTarget;
            button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-red-600', 'hover:bg-red-700');
            button.classList.add('bg-gray-400', 'hover:bg-gray-500');

            hasDownloaded = true;

            // --- STEP 2: Update Install Card (From PENDING/Gray to ACTIVE/Indigo) ---
            updateSectionColors(
                'installSection',
                'bg-indigo-50',
                'border-indigo-500',
                'text-indigo-800',
                '2. Install the Utility'
            );

            // 2. Autoscroll to the Install Command Box
            const installSection = document.getElementById('installSection');
            if (installSection) {
                installSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }


    function copyCommand() {
        const codeBlock = document.getElementById('installCommand').querySelector('code');
        const commandText = codeBlock ? codeBlock.textContent.trim() : '';
        const copyButton = document.querySelector('button[onclick="copyCommand()"]');
        const copyIcon = document.getElementById('copyIcon');
        const copyTextSpan = document.getElementById('copyText');
        const copyMessage = document.getElementById('copyMessage');

        if (!commandText) return;

        // Use the modern clipboard API if available, fall back to execCommand
        if (navigator.clipboard) {
            navigator.clipboard.writeText(commandText).then(() => {
                showCopySuccess(copyButton, copyIcon, copyTextSpan, copyMessage);
            }).catch(err => {
                console.error('Async Copy failed:', err);
                // Fallback to execCommand if modern API fails or is unavailable
                fallbackCopy(commandText, copyButton, copyIcon, copyTextSpan, copyMessage);
            });
        } else {
            // Fallback for older browsers
            fallbackCopy(commandText, copyButton, copyIcon, copyTextSpan, copyMessage);
        }
    }

    function fallbackCopy(commandText, copyButton, copyIcon, copyTextSpan, copyMessage) {
        const textarea = document.createElement('textarea');
        textarea.value = commandText;
        document.body.appendChild(textarea);
        textarea.select();

        let success = false;
        try {
            success = document.execCommand('copy');
        } catch (err) {
            console.error('ExecCommand Copy failed:', err);
        }

        document.body.removeChild(textarea);

        if (success) {
            showCopySuccess(copyButton, copyIcon, copyTextSpan, copyMessage);
        }
    }

    function showCopySuccess(copyButton, copyIcon, copyTextSpan, copyMessage) {
        const originalBg = 'bg-indigo-600';
        const originalHoverBg = 'hover:bg-indigo-700';
        const successBg = 'bg-green-600';
        const successHoverBg = 'hover:bg-green-700';

        copyButton.classList.remove(originalBg, originalHoverBg);
        copyButton.classList.add(successBg, successHoverBg);

        copyIcon.classList.add('hidden');
        copyTextSpan.classList.remove('hidden');
        copyTextSpan.textContent = 'Copied!';

        copyMessage.classList.remove('opacity-0');
        copyMessage.classList.add('opacity-100');

        setTimeout(() => {
            copyButton.classList.remove(successBg, successHoverBg);
            copyButton.classList.add(originalBg, originalHoverBg);

            copyIcon.classList.remove('hidden');
            copyTextSpan.textContent = 'Copy';

            copyMessage.classList.remove('opacity-100');
            copyMessage.classList.add('opacity-0');
        }, 2000);
    }


    // Centralized UI initialization function
    function initUI() {
        const downloadButton = document.getElementById('downloadButton');
        const downloadTitle = document.getElementById('downloadTitle');
        const downloadSubtext = document.getElementById('downloadSubtext');
        const installSection = document.getElementById('installSection');
        const installTitle = document.getElementById('installTitle');
        const installSubtext = document.getElementById('installSubtext');
        const installCommandCode = document.getElementById('installCommand').querySelector('code');
        const downloadAria = document.getElementById('downloadButton');
        const switchLinux = document.getElementById('switchLinux');
        const switchMac = document.getElementById('switchMac');

        // 1. OS Switcher Styling
        [switchLinux, switchMac].forEach(button => {
            button.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600', 'bg-white', 'text-gray-700', 'border-gray-300');
        });

        if (userOS === 'Linux' || userOS === 'ChromeOS' || userOS === 'Windows') {
            switchLinux.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            switchMac.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        } else if (userOS === 'Mac') {
            switchMac.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            switchLinux.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        }


        // 2. OS-Specific Content Logic
        downloadButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-gray-400', 'hover:bg-gray-500');
        downloadButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

        if (userOS === 'Mac') {
            // Mac instructions
            downloadButton.href = '#'; // Use # since JS handles the download trigger
            // Updated text to reflect the dual download behavior
            downloadButton.innerHTML = `<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Download Both Files`;
            downloadTitle.textContent = "1. Download Both Mac Files";
            downloadSubtext.textContent = "Click the button below to automatically download both **`backup.sh`** and **`backup_completion.sh`** with a single click.";
            downloadAria.setAttribute('aria-label', 'Download both Mac files for the utility and autocomplete');

            installTitle.textContent = "2. Install Utility & Autocomplete (Mac)";
            installSubtext.textContent = "Once both files are downloaded to your Downloads folder, run these commands in your Mac terminal to install the utility globally and enable autocompletion:";

            // Mac installation commands (Global script + Zsh completion)
            installCommandCode.textContent =
                `unzip BACKUP.zip
mv ~/Downloads/backup.sh /usr/local/bin/backup
chmod +x /usr/local/bin/backup
mv ~/Downloads/backup_completion.sh /usr/local/share/zsh/site-functions/_backup
autoload -U compinit && compinit`;

        } else if (userOS === 'Windows') {
            // Windows Warning
            downloadButton.href = '#';
            downloadTitle.textContent = "1. Download the Debian Package";
            downloadSubtext.textContent = `Warning: This package is for Linux. Your OS (${userOS}) is not compatible.`;
            downloadButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            downloadButton.classList.add('bg-red-600', 'hover:bg-red-700');
            downloadButton.innerHTML = `<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Download Latest .DEB (With Warning)`;
            downloadAria.setAttribute('aria-label', 'Download the Linux Debian Package (Warning: OS Incompatible)');

            // Reset install section content to Linux default
            installTitle.textContent = "2. Install the Utility";
            installSubtext.textContent = "Once downloaded, run these commands in your terminal:";
            installCommandCode.textContent =
                `sudo apt install zip tar -y
sudo dpkg -i BACKUP.deb`;

        } else {
            // Linux / ChromeOS (Compatible with Debian package)
            downloadButton.href = '#';
            downloadButton.innerHTML = `<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Download Latest .DEB (With Autocomplete!)`;
            downloadTitle.textContent = "1. Download the Package";
            downloadSubtext.textContent = "Get the latest Debian package (`.deb` file) with **built-in autocomplete** from the GitHub Releases page.";
            downloadAria.setAttribute('aria-label', 'Download the Linux Debian Package');

            // Reset install section content to Linux default
            installTitle.textContent = "2. Install the Utility";
            installSubtext.textContent = "Once downloaded, run these commands in your terminal:";
            installCommandCode.textContent =
                `sudo apt install zip tar -y
sudo dpkg -i BACKUP.deb`;
        }

        // 3. Set initial download state colors (reflects 'hasDownloaded' state)
        if (hasDownloaded) {
             updateSectionColors(
                'downloadSection',
                'bg-gray-100',
                'border-gray-400',
                'text-gray-700',
                userOS === 'Mac' ? '1. Files Downloading...' : '1. Package Downloading...'
            );
            document.getElementById('downloadButton').classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-red-600', 'hover:bg-red-700');
            document.getElementById('downloadButton').classList.add('bg-gray-400', 'hover:bg-gray-500');

            updateSectionColors(
                'installSection',
                'bg-indigo-50',
                'border-indigo-500',
                'text-indigo-800',
                '2. Install the Utility'
            );

        } else {
            // Set initial state for sections (Active download, Pending install)
            updateSectionColors(
                'downloadSection',
                'bg-indigo-50',
                'border-indigo-500',
                'text-indigo-800',
                downloadTitle.textContent
            );
            updateSectionColors(
                'installSection',
                'bg-gray-100',
                'border-gray-400',
                'text-gray-700',
                installTitle.textContent
            );
        }
    }


    // Initialize: Run the UI setup on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Initial OS detection logic (runs once on load)
        const userAgent = navigator.userAgent;
        if (userAgent.includes('Mac')) {
            userOS = 'Mac';
        } else if (userAgent.includes('Win')) {
            userOS = 'Windows';
        } else if (userAgent.includes('CrOS')) {
            userOS = 'Linux'; // Treat ChromeOS as compatible with Debian/Linux install
        }

        initUI();

        // Set Dynamic Footer Year
        const footer = document.getElementById('dynamicFooter');
        if (footer) {
            footer.textContent = `Â© ${new Date().getFullYear()} Simple Hecker typer. All rights reserved.`;
        }
    });
</script>
